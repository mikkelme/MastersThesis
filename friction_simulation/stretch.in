###########################################
# Relax and stretch system, and export    #
# restart files if num_stretch_files > 0. #
###########################################

# Consider moving this to setup_sim instead for more generality
# 0 = False, else = True
variable rupture_detection equal 1 # 



# Setup system
include ${root}/setup_sim.in



# --- Rupture detection computes --- #
if "!${rupture_detection}" then "jump SELF no_rupture_computes"

variable local_Nevery equal 1     # use input values every this many time steps
variable local_Nrepeat equal 10    # number of times to use input values for calculating averages
variable local_Nfreq equal 10    # calculate averages every this many time steps


# y-stress
compute YS sheet reduce ave c_peratom[2]
fix YS sheet ave/time ${local_Nevery} ${local_Nrepeat} ${local_Nfreq} c_YS file YS.txt # time average

# Cluster count
compute cluster_atom full_sheet cluster/atom 4.0 # Atoms clustering within threshold
compute Nchunk full_sheet chunk/atom c_cluster_atom compress yes # Non empty chunks (accesing as a scalar gives num chunks)
fix Nchunk full_sheet ave/time ${local_Nevery} ${local_Nrepeat} ${local_Nfreq} c_Nchunk file cluster.txt # time average

label no_rupture_computes 




# ----------  Write restart files ---------- #
variable num_stretch_files index 0
if "${num_stretch_files}<=1" then "jump SELF no_restart"

variable restart_freq equal floor(v_stretch_steps/(v_num_stretch_files-1))
variable       stride equal stride(v_relax_steps,$(v_relax_steps+v_stretch_steps+v_restart_freq),v_restart_freq)
restart        v_stride stretch_*_restart


label no_restart


# ----------  Relax sheet ---------- #
# Add spring to restrict rotation or movement of sheet COM:
#  - Hold PB COM in initial x-position
#  - Hold sheet COM in initial position
fix PB_ylow_x_hold PB_ylow_rigid spring tether 1e5 $(c_sheet_COM[1]) NULL NULL 0.0
fix PB_high_x_hold PB_yhigh_rigid spring tether 1e5 $(c_sheet_COM[1]) NULL NULL 0.0
fix sheet_COM_hold full_sheet spring tether 1e5 $(c_sheet_COM[1]) $(c_sheet_COM[2]) NULL 0.0

print "--> Relax: $(v_relax_steps) timesteps, $(v_relax_steps*dt) ps"
thermo_style custom step time cpu cpuremain c_sheetTemp c_subtopTemp v_stretch_pct v_sheet_bond_pct v_full_sheet_bond_pct
run $(v_relax_steps-1)

# Lock S0 after relaxing and export S0 info via y-pos of tmp type 3 atom
variable S0 equal $(v_S0) 
if  "${num_stretch_files}>=1" then "create_atoms 3 single 0 $(v_S0) 0" &
"group S0_info type 3"
run 1

unfix PB_ylow_x_hold
unfix PB_high_x_hold
unfix sheet_COM_hold



# ---------- Stretch sheet ---------- # 
# Update fixes
fix ylow_move  PB_ylow_rigid move linear 0 $(-v_stretch_speed/2) NULL units box
fix yhigh_move PB_yhigh_rigid move linear 0 $(v_stretch_speed/2) NULL units box
print "--> Stretch: $(v_stretch_steps) timesteps, $(v_stretch_steps*dt) ps"

### No rupture detection ###
if "${rupture_detection}" then "jump SELF rupture_detection_stretch"
run $(v_stretch_steps)
restart 0
jump SELF after_stretch



### No rupture detection ###
label rupture_detection_stretch

variable detection_freq equal 1000

fix YS_mean_vec sheet vector ${local_Nfreq} f_YS # Store mean values in vector
variable max_YS equal max(f_YS_mean_vec)
variable latest_YS equal f_YS

thermo_style custom step time cpu cpuremain v_stretch_pct v_latest_YS v_max_YS 


# run $(v_stretch_steps) every 3000 &
#     "if '$(f_YS) < $(0.5*v_max_YS) && $(v_stretch_pct) > 0.03' then 'print STOP=LASTMAX'" &
#     "if '$(f_Nchunk) > 1.5' then 'print STOP=NCHUNK'" #&
#     # "unfix YS_mean_vec" &
#     # "fix YS_mean_vec sheet vector ${local_Nfreq} f_YS"

variable A equal $(v_latest_YS>1e6)
variable B equal $(v_stretch_pct>0.1)
# variable condition equal $(v_A && v_B)
variable condition equal $(f_YS < 0.5*v_max_YS && v_stretch_pct > 0.03)

print $(v_condition)
quit


fix rupture_detector sheet halt ${detection_freq} v_A || $(v_B) error continue
# fix rupture_detector sheet halt ${detection_freq} $(v_latest_YS)>1e6 || $(v_stretch_pct)>0.03 error continue
run $(v_stretch_steps)


print "STOPPED"





# ---------- After stretch ---------- # 
label after_stretch

# Unfix moves (relevant if continued directly)
unfix ylow_move
unfix yhigh_move




