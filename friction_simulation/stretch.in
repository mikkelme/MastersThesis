# Setup system
include ${root}/setup_sim.in

# ----------  Write restart files ---------- #
variable num_stretch_files index 0
if "${num_stretch_files}<=1" then "jump SELF no_restart"

variable restart_freq equal floor(v_stretch_steps/(v_num_stretch_files-1))
variable       stride equal stride(v_relax_steps,$(v_relax_steps+v_stretch_steps+v_restart_freq),v_restart_freq)
restart        v_stride stretch_*_restart


# Maybe use a loop such that one can print out multil stretch files...
^^^^^^^
fix extra all print $(v_stride) "$(step) ${stretch_pct}" file restart_stretch_test.in
# fix extra all print $(v_stride) "if '$(step) <= '$(step)'' then 'variable stretch_pct equal '$(v_stretch_pct)'' " file restart_stretch_test.in
# fix extra all print $(v_stride) "if $(step) <= $(step) then 'variable stretch_pct equal '$(v_stretch_pct)'' " file restart_stretch_test.in
quit


label no_restart

# ----------  Relax sheet ---------- #
print "--> Relax: $(v_relax_steps) timesteps, $(v_relax_steps*dt) ps"
thermo_style custom step time cpu cpuremain temp v_stretch_pct v_sheet_bond_pct v_full_sheet_bond_pct
variable S0 equal c_PB_yhigh_ymin-c_PB_ylow_ymax # Force S0 to current length
run $(v_relax_steps)


# ---------- Stretch sheet ---------- #
# Update fixes
unfix nve
unfix nvt
fix nve free_atoms nve
fix nvt free_atoms langevin ${temp} ${temp} ${damp} 48279
fix ylow_move  PB_ylow move linear 0 $(-v_stretch_speed/2) NULL units box
fix yhigh_move PB_yhigh move linear 0 $(v_stretch_speed/2) NULL units box

print "--> Stretch: $(v_stretch_steps) timesteps, $(v_stretch_steps*dt) ps"
variable S0 equal $(c_PB_yhigh_ymin-c_PB_ylow_ymax) # Lock S0 after relaxing

# # Testing
# variable stretch_ideal equal v_stretch_max_pct*(step-v_relax_steps)/v_stretch_steps 
# thermo_style custom step time cpu cpuremain temp v_stretch_pct v_stretch_ideal
# ######
run $(v_stretch_steps)
restart 0

# Unfix moves (relevant if continued directly)
unfix ylow_move
unfix yhigh_move
velocity PB_tot set 0 0 0


